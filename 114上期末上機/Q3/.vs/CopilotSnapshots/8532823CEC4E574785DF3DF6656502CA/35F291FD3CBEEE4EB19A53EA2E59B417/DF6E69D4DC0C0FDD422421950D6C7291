using System;
using System.IO;
using System.Windows.Forms;

namespace Q3
{
    public partial class Form1 : Form
    {
        private int[] generatedNumbers = new int[5];
        private int[] drawNumbers = new int[5];

        public Form1()
        {
            InitializeComponent();
        }

        // 產生不重複亂數 (1-49)
        private void btnGenerate_Click(object sender, EventArgs e)
        {
            Random rnd = new Random();
            for (int i = 0; i < 5; i++)
            {
                int num;
                bool exists;
                do
                {
                    num = rnd.Next(1, 50); // 1..49
                    exists = false;
                    for (int j = 0; j < i; j++)
                    {
                        if (generatedNumbers[j] == num)
                        {
                            exists = true;
                            break;
                        }
                    }
                } while (exists);

                generatedNumbers[i] = num;
            }

            // Display
            for (int i = 0; i < 5; i++)
            {
                lblNumbers[i].Text = generatedNumbers[i].ToString();
            }

            // enable compare only if draw numbers are loaded
            btnCompare.Enabled = true && IsDrawLoaded();
            lblResult.Text = "結果：已產生號碼";
        }

        private bool IsDrawLoaded()
        {
            for (int i = 0; i < 5; i++)
            {
                if (drawNumbers[i] == 0) return false;
            }
            return true;
        }

        // 讀取開獎號碼檔案，每行一個數字，共五行
        private void btnLoadDraw_Click(object sender, EventArgs e)
        {
            if (openFileDialog.ShowDialog() != DialogResult.OK) return;
            string path = openFileDialog.FileName;
            try
            {
                using (StreamReader sr = new StreamReader(path))
                {
                    string line;
                    int index = 0;
                    lstDraw.Items.Clear();
                    for (int i = 0; i < 5; i++) drawNumbers[i] = 0;

                    while ((line = sr.ReadLine()) != null && index < 5)
                    {
                        line = line.Trim();
                        if (line == "") continue;
                        int val;
                        if (!int.TryParse(line, out val))
                        {
                            MessageBox.Show($"檔案格式錯誤：第 {index + 1} 行無法轉為整數", "錯誤", MessageBoxButtons.OK, MessageBoxIcon.Error);
                            return;
                        }

                        if (val < 1 || val > 49)
                        {
                            MessageBox.Show($"數字超出範圍 (1-49)：{val}", "錯誤", MessageBoxButtons.OK, MessageBoxIcon.Error);
                            return;
                        }

                        // 檢查重複
                        for (int j = 0; j < index; j++)
                        {
                            if (drawNumbers[j] == val)
                            {
                                MessageBox.Show($"檔案包含重複數字：{val}", "錯誤", MessageBoxButtons.OK, MessageBoxIcon.Error);
                                return;
                            }
                        }

                        drawNumbers[index] = val;
                        lstDraw.Items.Add(val.ToString());
                        index++;
                    }

                    if (index != 5)
                    {
                        MessageBox.Show("檔案內容不足5個有效數字", "錯誤", MessageBoxButtons.OK, MessageBoxIcon.Error);
                        return;
                    }
                }

                MessageBox.Show("已成功讀取開獎號碼", "資訊", MessageBoxButtons.OK, MessageBoxIcon.Information);
                btnCompare.Enabled = true && AreGeneratedNumbersPresent();
                lblResult.Text = "結果：已讀取開獎號碼";
            }
            catch (FileNotFoundException)
            {
                MessageBox.Show("檔案不存在", "錯誤", MessageBoxButtons.OK, MessageBoxIcon.Error);
            }
            catch (Exception ex)
            {
                MessageBox.Show("讀取檔案發生錯誤：" + ex.Message, "錯誤", MessageBoxButtons.OK, MessageBoxIcon.Error);
            }
        }

        private bool AreGeneratedNumbersPresent()
        {
            for (int i = 0; i < 5; i++)
            {
                if (generatedNumbers[i] == 0) return false;
            }
            return true;
        }

        // 比對中獎
        private void btnCompare_Click(object sender, EventArgs e)
        {
            if (!IsDrawLoaded())
            {
                MessageBox.Show("請先讀取開獎號碼檔案", "提示", MessageBoxButtons.OK, MessageBoxIcon.Information);
                return;
            }
            if (!AreGeneratedNumbersPresent())
            {
                MessageBox.Show("請先按下產生號碼", "提示", MessageBoxButtons.OK, MessageBoxIcon.Information);
                return;
            }

            int match = 0;
            for (int i = 0; i < 5; i++)
            {
                for (int j = 0; j < 5; j++)
                {
                    if (generatedNumbers[i] == drawNumbers[j])
                    {
                        match++;
                        break;
                    }
                }
            }

            string prize;
            switch (match)
            {
                case 5: prize = "頭獎"; break;
                case 4: prize = "貳獎"; break;
                case 3: prize = "參獎"; break;
                case 2: prize = "安慰獎"; break;
                case 1: prize = "沒中獎"; break;
                default: prize = "沒中獎"; break;
            }

            lblResult.Text = $"結果：中獎數量 {match}，獎項：{prize}";
        }

        private void btnExit_Click(object sender, EventArgs e)
        {
            this.Close();
        }
    }
}
